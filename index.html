function playTry(n) {
  if (n !== tries + 1) {
    alert("Vous devez écouter les extraits dans l'ordre.");
    return;
  }
  tries = n;
  document.getElementById("result").textContent = "";
  document.getElementById("result").className = "";
  document.getElementById("guessInput").disabled = false;
  document.getElementById("checkAnswerBtn").disabled = false;
  document.getElementById("skipBtn").disabled = false;

  // Si écoute 3, on lance le timer 20s visible
  if (tries === 3) {
    startFinalTimer(20);
  } else {
    clearFinalTimer();
  }

  player.loadVideoById({
    videoId: currentAnime.videoId,
    startSeconds: currentAnime.startTime,
    endSeconds: currentAnime.startTime + tryDurations[tries - 1]
  });
  player.playVideo();

  // Mise à jour boutons écoute
  document.getElementById("playTry1").disabled = tries >= 1;
  document.getElementById("playTry2").disabled = tries < 1 || tries >= 2;
  document.getElementById("playTry3").disabled = tries < 2 || tries >= 3;
}

let finalTimerInterval = null;

function startFinalTimer(seconds) {
  const timerDiv = document.getElementById("timer");
  let timeLeft = seconds;
  timerDiv.style.display = "block";
  timerDiv.textContent = `Temps restant : ${timeLeft} secondes`;

  // Désactivation des boutons d'écoutes (car on est à la 3e écoute)
  document.getElementById("playTry1").disabled = true;
  document.getElementById("playTry2").disabled = true;
  document.getElementById("playTry3").disabled = true;

  finalTimerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft > 0) {
      timerDiv.textContent = `Temps restant : ${timeLeft} secondes`;
    } else {
      clearInterval(finalTimerInterval);
      timerDiv.style.display = "none";
      revealAnswer();
    }
  }, 1000);
}

function clearFinalTimer() {
  if (finalTimerInterval) {
    clearInterval(finalTimerInterval);
    finalTimerInterval = null;
    const timerDiv = document.getElementById("timer");
    timerDiv.style.display = "none";
    timerDiv.textContent = "";
  }
}

function checkAnswer() {
  const inputVal = document.getElementById("guessInput").value.trim().toLowerCase();
  const resultDiv = document.getElementById("result");
  if (!inputVal) return;

  if (currentAnime.altTitles.includes(inputVal)) {
    // Bonne réponse
    resultDiv.textContent = `✅ Bravo ! C’est ${currentAnime.title} - ${currentAnime.opening}`;
    resultDiv.className = "correct";
    blockInputs();
    clearFinalTimer();
    setTimeout(nextAnime, 2000);
  } else {
    // Mauvaise réponse
    resultDiv.textContent = `❌ Faux. Ce n'est pas "${document.getElementById("guessInput").value}".`;
    resultDiv.className = "incorrect";
    blockInputs();
    clearFinalTimer();
    revealAnswer(); // Perdu dès qu'une tentative est ratée à l'écoute 3
  }
}
