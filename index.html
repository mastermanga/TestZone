<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guess The Anime Opening</title>
<style>
  body {
    background-color: #121212;
    color: #eee;
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  input, button, select {
    font-size: 1rem;
    padding: 8px;
    margin: 5px 0;
    border-radius: 4px;
    border: none;
  }
  input, select {
    width: 100%;
    max-width: 400px;
  }
  button {
    cursor: pointer;
    background-color: #333;
    color: #eee;
    border: 1px solid #555;
  }
  button:disabled {
    background-color: #222;
    color: #666;
    cursor: not-allowed;
  }
  #result {
    margin-top: 10px;
    font-weight: bold;
  }
  #timer {
    font-size: 1.2rem;
    margin-top: 15px;
    color: #f55;
  }
  #playerWrapper {
    height: 0;
    width: 0;
    overflow: hidden;
  }
</style>
</head>
<body>

<h1>Guess The Anime Opening</h1>

<select id="guessInput">
  <option value="" selected disabled>Choisissez un anime...</option>
</select>

<div>
  <button id="playTry1">Écoute 1 (3s)</button>
  <button id="playTry2" disabled>Écoute 2 (5s)</button>
  <button id="playTry3" disabled>Écoute 3 (10s)</button>
</div>

<button id="checkAnswer">Valider la réponse</button>

<div id="result"></div>
<div id="timer"></div>

<div id="playerWrapper"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let animeList = [
  { title: "My Hero Academia", youtubeUrl: "https://www.youtube.com/watch?v=L1FdEBTJXus" },
  { title: "Hunter X Hunter", youtubeUrl: "https://www.youtube.com/watch?v=faqmNf_fZlE" },
  { title: "Naruto", youtubeUrl: "https://www.youtube.com/watch?v=vxvP9zSOL7s" },
  { title: "Attack on Titan", youtubeUrl: "https://www.youtube.com/watch?v=8OkpRK2_gVs" },
  { title: "Jujutsu Kaisen", youtubeUrl: "https://www.youtube.com/watch?v=GwaRztMaoY0" }
];

// Extraire videoId depuis l'URL Youtube
function extractVideoId(url) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
}

animeList.forEach(a => {
  a.videoId = extractVideoId(a.youtubeUrl);
});

// Variables d'état
let currentIndex = 0;
let player;
let triesDone = 0;  // nombre d'écoutes faites (max 3)
let maxTries = 3;
let timerInterval;
let timerCountdown = 10; // secondes pour timer final

// Définir anime courant
function currentAnime() {
  return animeList[currentIndex];
}

// Remplir la liste déroulante
const guessInput = document.getElementById("guessInput");
function populateSelect() {
  animeList.forEach(anime => {
    const option = document.createElement("option");
    option.value = anime.title;
    option.textContent = anime.title;
    guessInput.appendChild(option);
  });
}
populateSelect();

// Initialisation du player YouTube
function onYouTubeIframeAPIReady() {
  player = new YT.Player('playerWrapper', {
    height: '0',
    width: '0',
    videoId: currentAnime().videoId,
    playerVars: {
      autoplay: 0,
      controls: 0,
      modestbranding: 1,
      rel: 0,
      iv_load_policy: 3
    },
    events: {
      onReady: () => {
        enableButton(1);
        disableButton(2);
        disableButton(3);
        triesDone = 0;
        resetUI();
      },
      onStateChange: onPlayerStateChange
    }
  });
}

// Gestion des boutons
function enableButton(n) {
  document.getElementById(`playTry${n}`).disabled = false;
}
function disableButton(n) {
  document.getElementById(`playTry${n}`).disabled = true;
}

function resetUI() {
  document.getElementById("result").textContent = "";
  document.getElementById("timer").textContent = "";
  guessInput.value = "";
  clearInterval(timerInterval);
  timerCountdown = 10;
}

// Jouer la vidéo pour une écoute donnée (durée en secondes)
function playTry(n) {
  if (!player) return;
  if (triesDone + 1 !== n) return; // respecter l'ordre

  let durations = [3, 5, 10];
  let start = 0;
  let duration = durations[n - 1];
  let end = start + duration;

  player.loadVideoById({
    videoId: currentAnime().videoId,
    startSeconds: start,
    endSeconds: end,
    suggestedQuality: 'small'
  });
  player.playVideo();

  triesDone = n;

  // Après écoute, activer suivant si possible
  if (triesDone < maxTries) {
    enableButton(triesDone + 1);
  }
  disableButton(triesDone);
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    if (triesDone === maxTries) {
      startFinalTimer();
    }
  }
}

// Timer final 10s pour répondre après écoute 3
function startFinalTimer() {
  let timerEl = document.getElementById("timer");
  timerCountdown = 10;
  timerEl.textContent = `⏳ Vous avez ${timerCountdown} secondes pour répondre...`;

  timerInterval = setInterval(() => {
    timerCountdown--;
    if (timerCountdown <= 0) {
      clearInterval(timerInterval);
      timerEl.textContent = "⏰ Temps écoulé ! Vous avez perdu.";
      nextAnime();
    } else {
      timerEl.textContent = `⏳ Vous avez ${timerCountdown} secondes pour répondre...`;
    }
  }, 1000);
}

// Vérification de la réponse
function checkAnswer() {
  const answer = guessInput.value.trim().toLowerCase();
  if (!answer) {
    alert("Veuillez choisir un anime.");
    return;
  }

  let correct = currentAnime().title.toLowerCase() === answer;

  let resultEl = document.getElementById("result");

  if (correct) {
    resultEl.textContent = `✅ Bravo ! C’est bien "${currentAnime().title}" !`;
    clearInterval(timerInterval);
    setTimeout(nextAnime, 2000);
  } else {
    resultEl.textContent = `❌ Faux... On passe à l'écoute suivante.`;
    if (triesDone < maxTries) {
      playTry(triesDone + 1);
    } else {
      resultEl.textContent += " C'est perdu !";
      setTimeout(nextAnime, 2000);
    }
  }
}

// Passer à l'anime suivant
function nextAnime() {
  clearInterval(timerInterval);
  timerCountdown = 10;
  currentIndex++;
  if (currentIndex >= animeList.length) {
    currentIndex = 0;
  }
  triesDone = 0;
  resetUI();
  if (player) {
    player.loadVideoById(currentAnime().videoId, 0);
    enableButton(1);
    disableButton(2);
    disableButton(3);
  }
}

// Gestion boutons écoute
document.getElementById("playTry1").addEventListener("click", () => playTry(1));
document.getElementById("playTry2").addEventListener("click", () => playTry(2));
document.getElementById("playTry3").addEventListener("click", () => playTry(3));

// Bouton valider réponse
document.getElementById("checkAnswer").addEventListener("click", checkAnswer);
</script>

</body>
</html>
